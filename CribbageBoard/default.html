<!DOCTYPE html>

<html>

<head>

    <meta charset="utf-8" />

    <title>Cribbage Board</title>

    <!-- WinJS references -->
    <link href="//Microsoft.WinJS.1.0/css/ui-dark.css" rel="stylesheet" />
    <script src="//Microsoft.WinJS.1.0/js/base.js"></script>
    <script src="//Microsoft.WinJS.1.0/js/ui.js"></script>

    <script>

        var isReady = false;
    </script>

    <link href="/css/default.css" rel="stylesheet" />
    <script src="/js/default.js"></script>
    <script src="/js/underscore.min.js"></script>
    <script src="/js/kinetic.min.js"> </script>
    <script src="/js/utils.js"></script>
    

    <script>
        var isLoaded = false;
        var undoData = new Array();
        var backgroundColor = '#1a1a1a';
		var rowOne = new Array();
    	var rowTwo = new Array();
    	var rowThree = new Array();
		
		var stage;

		var pegIndexes = [0, 1, 0, 1, 0, 1];
		
		var pegBlueOne;
		var pegBlueTwo;
		var pegYellowOne;
		var pegYellowTwo;
		var pegRedOne;
		var pegRedTwo;

		var pegRedLayer = new Kinetic.Layer();
		var pegYellowLayer = new Kinetic.Layer();
		var pegBlueLayer = new Kinetic.Layer();
		var messageLayer = new Kinetic.Layer();
		var lineLayer = new Kinetic.Layer();
        
		var pegOneColor = '#2572EB';
		var pegTwoColor = '#AED136';
		var pegThreeColor = '#AD103C';

		buildArrays();

		var simpleText = new Kinetic.Text({
		    x: 0,
		    y: 0,
		    text: '',
		    fontSize: 48,
            fontSyle: 'bold',
		    fontFamily: 'Calibri',
		    fill: 'green'/*,
		    shadowColor: 'black',
		    shadowBlur: 5*/
		});

		var redLine = new Kinetic.Line({
		    points: [0, 0, 0, 0],
		    stroke: pegThreeColor,
		    strokeWidth: 5,
		    opacity: 1,
		    lineCap: 'round',
		    lineJoin: 'round'
		});

		var yellowLine = new Kinetic.Line({
		    points: [0, 0, 0, 0],
		    stroke: pegTwoColor,
		    strokeWidth: 5,
		    opacity: 1,
		    lineCap: 'round',
		    lineJoin: 'round'
		});

        /**
         * Used for displaying the blue line in the app.
         *
         */
		var blueLine = new Kinetic.Line({
		    points: [0, 0, 0, 0],
		    stroke: pegOneColor,
		    strokeWidth: 5,
		    opacity: 1,
		    lineCap: 'round',
		    lineJoin: 'round'
		});

        /**
         * When the screen size changes, update the layout of the app.
         *
         */
		window.onresize = function(event) {
		    init();
		}

		function loadComplete() {
		    isLoaded = true;
		    if (isReady) {
		        init();
		    }
		}

        /**
         * Minimum size of the stage for a Windows 8 tablet app is 1024x768.
         *
         */
		function init() {
            // Calculate the scale based on the window size.
		    var scale = window.innerHeight / 768;

            // Update the container div
		    document.getElementById('container').style.width = (1024 * scale) + "px";
		    document.getElementById('container').style.height = window.innerHeight + "px";
           
             if (stage) {
                // If we have a stage, resize.
		        stage.setWidth(1024 * scale);
		        stage.setHeight(window.innerHeight);
		        stage.setScale(scale);
		        stage.draw();
             } else {
                 var sources = {
                     redPegImage: 'images/pegRed.png',
                     yellowPegImage: 'images/pegGreen.png',
                     bluePegImage: 'images/pegBlue.png'
                 };

                 loadImages(sources, function (images) {
                     drawPegs(images);
                 });
                // If we don't have a stage, build one and initialize the app
		        stage = new Kinetic.Stage({
		            container: 'container',
		            width: 1024 * scale,
		            height: window.innerHeight,
		            scale: scale
		        });
		        var backgroundLayer = new Kinetic.Layer();
		        stage.add(backgroundLayer);

		        var imageObj = new Image();
		        imageObj.onload = function () {
		            var board = new Kinetic.Image({
		                x: 0,
		                y: 0,
		                image: imageObj,
		                width: 1024,
		                height: 768
		            });

		            // add the shape to the layer
		            backgroundLayer.add(board);
		            backgroundLayer.draw();
		        };
		        imageObj.src = 'images/cribbage.png';

		        //showDots(); // Used for debugging
		        //drawPegs();
		        lineLayer.add(redLine);
		        lineLayer.add(blueLine);
		        lineLayer.add(yellowLine);
		        stage.add(lineLayer);
		        stage.add(pegRedLayer);
		        stage.add(pegYellowLayer);
		        stage.add(pegBlueLayer);
		        messageLayer.add(simpleText);
		        stage.add(messageLayer);
		    }
		}

		function loadImages(sources, callback) {
		    var images = {};
		    var loadedImages = 0;
		    var numImages = 0;
		    // get num of sources
		    for (var src in sources) {
		        numImages++;
		    }
		    for (var src in sources) {
		        images[src] = new Image();
		        images[src].onload = function () {
		            if (++loadedImages >= numImages) {
		                callback(images);
		            }
		        };
		        images[src].src = sources[src];
		    }
		}

		function writeMessage(messageLayer, message, xPos, yPos, color) {
		    simpleText.setText(message);
		    //simpleText.setX(xPos - 20);
		    //simpleText.setY(yPos - 100);
		    simpleText.setFill(color);
		    messageLayer.draw();
		}

		function placePeg(peg, row)
		{
		  var blueIndex = 0;
		  var closest = 500;
		  var pegPoint = new Point(peg.getX(), peg.getY());
		  for(var p = 0; p < row.length; p++)
		  {
			var dist = getDistanceGivenPoints(pegPoint, row[p]);
			
			if(dist < closest){
			  closest = dist;
			  blueIndex = p;
			}
		  }
		  switch(peg){
			case pegBlueOne:
			  if(blueIndex == pegIndexes[1]){
				blueIndex ++;
			  }
			  break;
			case pegBlueTwo:
			  if(blueIndex == pegIndexes[0]){
				blueIndex ++;
			  }
			  break;
		    case pegYellowOne:
		        if (blueIndex == pegIndexes[3]) {
		            blueIndex++;
		        }
		    case pegYellowTwo:
		        if (blueIndex == pegIndexes[2]) {
		            blueIndex++;
		        }
		        break;

			case pegRedOne:
			  if(blueIndex == pegIndexes[5]){
				blueIndex ++;
			  }
			  break;
			case pegRedTwo:
			  if(blueIndex == pegIndexes[4]){
				blueIndex ++;
			  }
			  break;
		  }
		  if(blueIndex > row.length - 1){
			blueIndex = 0;
		  }
		  peg.setX(row[blueIndex].x);
		  peg.setY(row[blueIndex].y);

		  return blueIndex;
		}

		function resetGame() {
		    undoData = new Array();
		    pegIndexes = [0, 1, 0, 1, 0, 1];
		    document.getElementById("undoButton").disabled = true;
		    updatePegs();
		}

		function updatePegs() {
		    console.log(pegIndexes);
		    pegBlueOne.setX(rowOne[pegIndexes[0]].x);
		    pegBlueOne.setY(rowOne[pegIndexes[0]].y);
		    pegBlueTwo.setX(rowOne[pegIndexes[1]].x);
		    pegBlueTwo.setY(rowOne[pegIndexes[1]].y);

		    pegYellowOne.setX(rowTwo[pegIndexes[2]].x);
		    pegYellowOne.setY(rowTwo[pegIndexes[2]].y);
		    pegYellowTwo.setX(rowTwo[pegIndexes[3]].x);
		    pegYellowTwo.setY(rowTwo[pegIndexes[3]].y);

		    pegRedOne.setX(rowThree[pegIndexes[4]].x);
		    pegRedOne.setY(rowThree[pegIndexes[4]].y);
		    pegRedTwo.setX(rowThree[pegIndexes[5]].x);
		    pegRedTwo.setY(rowThree[pegIndexes[5]].y);

		    normalizePegs(4, 5, pegRedOne, pegRedTwo);
		    normalizePegs(0, 1, pegBlueOne, pegBlueTwo);
		    normalizePegs(2, 3, pegYellowOne, pegYellowTwo);

		    pegBlueLayer.draw();
		    pegYellowLayer.draw();
		    pegRedLayer.draw();
		}

		function undo() {
		    if (undoData.length > 0) {
		        pegIndexes = undoData.pop();
		        updatePegs();
		    }
		    if (undoData.length == 0) {
		        document.getElementById("undoButton").disabled = true;
		    }
		    
		}
		// Command and Flyout functions.
		function showConfirmFlyout() {
		    showFlyout(confirmFlyout, cmdHelpId, "top");
		}
		function showFlyout(flyout, anchor, placement) {
		    flyout.winControl.show(anchor, placement);
		}

		window.addEventListener("resize", onResize, false);

		function onResize() {
		    var pageName = "homePage";
		    if (Windows.UI.ViewManagement.ApplicationView.value == Windows.UI.ViewManagement.ApplicationViewState.snapped) {
		        document.getElementById("container").style.display = "none";
		        document.getElementById("snapView").style.display = "block";

		    } else {
		        document.getElementById("container").style.display = "block";
		        document.getElementById("snapView").style.display = "none";
		    }
		}

	</script>
</head>

<body onLoad="loadComplete();">
    
    <!-- BEGINTEMPLATE: Template code for an app bar -->
    <div id="appBar" data-win-control="WinJS.UI.AppBar" data-win-options="">
        <button onclick="undo();" id="undoButton" disabled="disabled"
            data-win-control="WinJS.UI.AppBarCommand" 
            data-win-options="{id:'cmdHelp',label:'Undo',icon:'undo',
                section:'global',tooltip:'Delete item'}">
        </button>
        <button onclick="showConfirmFlyout()" id="cmdHelpId"
            data-win-control="WinJS.UI.AppBarCommand" 
            data-win-options="{id:'cmdHelp',label:'Help',icon:'help',
                section:'global',tooltip:'Delete item'}">
        </button>
        <button onclick="resetGame();"
            data-win-control="WinJS.UI.AppBarCommand" 
            data-win-options="{id:'cmdReset',label:'New Game',icon:'page',
                section:'selection',tooltip:'Reset'}">
        </button>
    </div>
    <!-- ENDTEMPLATE -->

    <!-- Confirmation Flyout. -->
    <div id="confirmFlyout" data-win-control="WinJS.UI.Flyout" aria-label="{Confirm purchase flyout}">
        <div>
            <h2>Quick Rules</h2>
            <hr />
            <h3>The Deal</h3>
            <p>52-card deck, jokers removed. For two players, each is dealt six cards. For three players each is dealt five cards. Two cards are discarded into the dealer's "crib." Then the player to the dealer's left cuts the deck and the top "starter" card is flipped over.</p>
            <br />
            <h3>The Play</h3>
            <p>The play starts with the player on the dealer's left and continues clockwise. Face cards are worth ten; Aces are worth one. Play must not exceed 31. A player who cannot lay a card without bringing the total above 31 passes by saying "Go."</p>
            <br />
            <h3>Pegging</h3>
            <p>Peg two points for playing a card that brings the total score to either 15 or 31. Peg one point for playing the last card. Peg two points for pairing a card that was just played.</p>
            <br />
            <h3>The Points</h3>
            <ul style="margin-left:20px">
                <li><strong>Fifteen-twos:</strong> Two points for each separate combination of two or more cards totalling exactly 15.</li>
                <li><strong>Runs:</strong> Three points for a run of three consecutive cards (regardless of suit), four points for a run of four and five points for a run of five.</li>
                <li><strong>Pairs:</strong> Two points for a pair of cards. Six points for three cards of a kind. Twelve points for four of a kind.</li>
                <li><strong>Flush:</strong> Four points for a flush, where all cards in your hand are the same suite. Five points for a five card flush.</li>
                <li><strong>Nobs:</strong> One piont for holding the Jack of the same suite as the "starter" card.</li>
            </ul>
        </div>
    </div>

    <div id="container" style></div>

    <div id="snapView" style="width:100%;height:100%;background-color:#9C0501;margin-top:-20px;padding-top:0px;display:none">
        <img src="images/widelogo.png" style="margin-top:-20px" />
    </div>
</body>

</html>