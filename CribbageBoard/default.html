<!DOCTYPE html>

<html>

<head>

    <meta charset="utf-8" />

    <title>Cribbage Board</title>

    <!-- WinJS references -->
    <link href="//Microsoft.WinJS.1.0/css/ui-dark.css" rel="stylesheet" />
    <script src="//Microsoft.WinJS.1.0/js/base.js"></script>
    <script src="//Microsoft.WinJS.1.0/js/ui.js"></script>

    <link href="/css/default.css" rel="stylesheet" />
    <script src="/js/default.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/kinetic-v4.3.1.min.js"> </script>

    <script>
        var backgroundColor = '#1a1a1a';
		var rowOne = new Array();
    	var rowTwo = new Array();
    	var rowThree = new Array();
		
		var stage;

		var pegIndexes = [0,1,0,1,0,1];
		
		var pegBlueOne;
		var pegBlueTwo;
		var pegYellowOne;
		var pegYellowTwo;
		var pegRedOne;
		var pegRedTwo;

		var pegRedLayer = new Kinetic.Layer();
		var pegYellowLayer = new Kinetic.Layer();
		var pegBlueLayer = new Kinetic.Layer();
		var messageLayer = new Kinetic.Layer();
		var lineLayer = new Kinetic.Layer();
        
		var pegOneColor = '#2572EB';
		var pegTwoColor = '#AED136';
		var pegThreeColor = '#AD103C';

		buildArrays();

		var simpleText = new Kinetic.Text({
		    x: 0,
		    y: 0,
		    text: '',
		    fontSize: 42,
            fontSyle: 'bold',
		    fontFamily: 'Calibri',
		    fill: 'green'/*,
		    shadowColor: 'black',
		    shadowBlur: 5*/
		});

		var redLine = new Kinetic.Line({
		    points: [0, 0, 0, 0],
		    stroke: pegThreeColor,
		    strokeWidth: 5,
		    opacity: 1,
		    lineCap: 'round',
		    lineJoin: 'round'
		});

		var yellowLine = new Kinetic.Line({
		    points: [0, 0, 0, 0],
		    stroke: pegTwoColor,
		    strokeWidth: 5,
		    opacity: 1,
		    lineCap: 'round',
		    lineJoin: 'round'
		});

        /**
         * Used for displaying the blue line in the app.
         *
         */
		var blueLine = new Kinetic.Line({
		    points: [0, 0, 0, 0],
		    stroke: pegOneColor,
		    strokeWidth: 5,
		    opacity: 1,
		    lineCap: 'round',
		    lineJoin: 'round'
		});

        /**
         * When the screen size changes, update the layout of the app.
         *
         */
		window.onresize = function(event) {
		    init();
		}

        /**
         * Minimum size of the stage for a Windows 8 tablet app is 1024x768.
         *
         */
		function init() {
            // Calculate the scale based on the window size.
		    var scale = window.innerHeight / 768;

            // Update the container div
		    document.getElementById('container').style.width = (1024 * scale) + "px";
		    document.getElementById('container').style.height = window.innerHeight + "px";
           
             if (stage) {
                // If we have a stage, resize.
		        stage.setWidth(1024 * scale);
		        stage.setHeight(window.innerHeight);
		        stage.setScale(scale);
		        stage.draw();
             } else {
                 var sources = {
                     redPegImage: 'images/pegRed.png',
                     yellowPegImage: 'images/pegGreen.png',
                     bluePegImage: 'images/pegBlue.png'
                 };

                 loadImages(sources, function (images) {
                     drawPegs(images);
                 });
                // If we don't have a stage, build one and initialize the app
		        stage = new Kinetic.Stage({
		            container: 'container',
		            width: 1024 * scale,
		            height: window.innerHeight,
		            scale: scale
		        });
		        var backgroundLayer = new Kinetic.Layer();
		        stage.add(backgroundLayer);

		        var imageObj = new Image();
		        imageObj.onload = function () {
		            var board = new Kinetic.Image({
		                x: 0,
		                y: 0,
		                image: imageObj,
		                width: 1024,
		                height: 768
		            });

		            // add the shape to the layer
		            backgroundLayer.add(board);
		            backgroundLayer.draw();
		        };
		        imageObj.src = 'images/cribbage.png';

		        //showDots(); // Used for debugging
		        //drawPegs();
		        lineLayer.add(redLine);
		        lineLayer.add(blueLine);
		        lineLayer.add(yellowLine);
		        stage.add(lineLayer);
		        stage.add(pegRedLayer);
		        stage.add(pegYellowLayer);
		        stage.add(pegBlueLayer);
		        messageLayer.add(simpleText);
		        stage.add(messageLayer);
		    }
		}

		function loadImages(sources, callback) {
		    var images = {};
		    var loadedImages = 0;
		    var numImages = 0;
		    // get num of sources
		    for (var src in sources) {
		        numImages++;
		    }
		    for (var src in sources) {
		        images[src] = new Image();
		        images[src].onload = function () {
		            if (++loadedImages >= numImages) {
		                callback(images);
		            }
		        };
		        images[src].src = sources[src];
		    }
		}

		function writeMessage(messageLayer, message, xPos, yPos, color) {
		    simpleText.setText(message);
		    //simpleText.setX(xPos - 20);
		    //simpleText.setY(yPos - 100);
		    simpleText.setFill(color);
		    messageLayer.draw();
		}

		function placePeg(peg, row)
		{
		  var blueIndex = 0;
		  var closest = 500;
		  var pegPoint = new Point(peg.getX(), peg.getY());
		  for(var p = 0; p < row.length; p++)
		  {
			var dist = getDistanceGivenPoints(pegPoint, row[p]);
			
			if(dist < closest){
			  closest = dist;
			  blueIndex = p;
			}
		  }
		  switch(peg){
			case pegBlueOne:
			  if(blueIndex == pegIndexes[1]){
				blueIndex ++;
			  }
			  break;
			case pegBlueTwo:
			  if(blueIndex == pegIndexes[0]){
				blueIndex ++;
			  }
			  break;
		    case pegYellowOne:
		        if (blueIndex == pegIndexes[3]) {
		            blueIndex++;
		        }
		    case pegYellowTwo:
		        if (blueIndex == pegIndexes[2]) {
		            blueIndex++;
		        }
		        break;

			case pegRedOne:
			  if(blueIndex == pegIndexes[5]){
				blueIndex ++;
			  }
			  break;
			case pegRedTwo:
			  if(blueIndex == pegIndexes[4]){
				blueIndex ++;
			  }
			  break;
		  }
		  if(blueIndex > row.length - 1){
			blueIndex = 0;
		  }
		  peg.setX(row[blueIndex].x);
		  peg.setY(row[blueIndex].y);

		  return blueIndex;
		}
	</script>
</head>

<body onLoad="init();">
    <div id="container"></div>
</body>

</html>